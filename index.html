<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertitore PDF to EPUB</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .upload-section {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
        }
        .preview-section {
            display: none;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .progress {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
            text-align: center;
            line-height: 20px;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Convertitore PDF to EPUB</h1>
    <div class="container">
        <div class="upload-section">
            <h3>Carica il tuo file PDF</h3>
            <input type="file" id="pdfInput" accept=".pdf">
            <p>Trasformerò il PDF in EPUB rimuovendo numeri di pagina, intestazioni ripetute e interruzioni non necessarie.</p>
        </div>
        
        <div class="preview-section">
            <h3>Anteprima del testo</h3>
            <p>Modifica il testo se necessario, poi procedi con la conversione.</p>
            <textarea id="previewText"></textarea>
            <button id="convertBtn">Converti in EPUB</button>
        </div>
        
        <div class="progress-bar" id="progressContainer">
            <div class="progress" id="progressBar">0%</div>
        </div>
    </div>

    <script>
        // Inizializza PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        
        let extractedText = '';
        let chapterPositions = [];
        
        document.getElementById('pdfInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument(arrayBuffer);
            
            try {
                const pdf = await loadingTask.promise;
                const numPages = pdf.numPages;
                extractedText = '';
                chapterPositions = [];
                
                // Analizza ogni pagina
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // Estrai il testo e analizza la struttura
                    const pageText = processPageText(textContent.items, i);
                    
                    // Verifica se è una pagina di capitolo (vuota o con margine superiore grande)
                    if (isChapterPage(textContent.items, page)) {
                        chapterPositions.push(extractedText.length);
                    }
                    
                    // Aggiorna la barra di progresso
                    updateProgress(i, numPages);
                }
                
                // Mostra l'anteprima
                document.getElementById('previewText').value = extractedText;
                document.querySelector('.preview-section').style.display = 'block';
                document.getElementById('progressContainer').style.display = 'none';
                
            } catch (error) {
                console.error('Errore durante il processing del PDF:', error);
                alert('Si è verificato un errore durante il processing del PDF.');
            }
        });
        
        function processPageText(textItems, pageNum) {
            let pageText = '';
            let prevItem = null;
            let isHeaderFooter = false;
            
            // Analizza ogni elemento di testo nella pagina
            for (const item of textItems) {
                // Ignora elementi con font molto piccoli (tipici di numeri di pagina)
                if (item.height < 10) continue;
                
                // Verifica se l'elemento è nell'area di header/footer
                if (item.transform[5] < 50 || item.transform[5] > 750) {
                    isHeaderFooter = true;
                } else {
                    isHeaderFooter = false;
                }
                
                // Se non è header/footer, processa il testo
                if (!isHeaderFooter) {
                    // Unisci le parole divise da hyphenation
                    if (prevItem && prevItem.str.endsWith('-')) {
                        pageText = pageText.slice(0, -1) + item.str;
                    } else {
                        // Aggiungi spazio se necessario
                        if (prevItem && !isPunctuation(prevItem.str) && !item.str.startsWith(' ')) {
                            pageText += ' ';
                        }
                        pageText += item.str;
                    }
                    
                    // Aggiungi a capo dopo punteggiatura rilevante
                    if (isRelevantPunctuation(item.str)) {
                        pageText += '\n';
                    }
                    
                    prevItem = item;
                }
            }
            
            return pageText;
        }
        
        function isChapterPage(textItems, page) {
            // Verifica se la pagina è vuota o quasi
            if (textItems.length < 5) return true;
            
            // Verifica margine superiore grande (primo elemento molto in basso)
            const firstItem = textItems[0];
            if (firstItem.transform[5] < page.view[3] - 100) return true;
            
            return false;
        }
        
        function isPunctuation(str) {
            return /^[.,;:!?)]$/.test(str.trim());
        }
        
        function isRelevantPunctuation(str) {
            return /^[.!?]$/.test(str.trim());
        }
        
        function updateProgress(current, total) {
            const progress = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').innerText = progress + '%';
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        document.getElementById('convertBtn').addEventListener('click', function() {
            const finalText = document.getElementById('previewText').value;
            createEPUB(finalText);
        });
        
        function createEPUB(text) {
            const zip = new JSZip();
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            // Crea la struttura base dell'EPUB
            const mimetype = zip.folder("mimetype");
            mimetype.file("mimetype", "application/epub+zip");
            
            const metaInf = zip.folder("META-INF");
            metaInf.file("container.xml", `<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);
            
            const oebps = zip.folder("OEBPS");
            
            // Divide il testo in capitoli
            let chapters = [];
            if (chapterPositions.length > 0) {
                let start = 0;
                for (const pos of chapterPositions) {
                    chapters.push(text.substring(start, pos).trim());
                    start = pos;
                }
                chapters.push(text.substring(start).trim());
            } else {
                chapters = [text];
            }
            
            // Crea i file HTML per ogni capitolo
            let tocItems = '';
            let manifestItems = '';
            let spineItems = '';
            
            chapters.forEach((chapter, index) => {
                const chapterNum = index + 1;
                const chapterId = `chapter${chapterNum}`;
                const chapterFile = `${chapterId}.xhtml`;
                
                oebps.file(chapterFile, `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
    <title>Capitolo ${chapterNum}</title>
    <meta charset="UTF-8"/>
    <style>
        body { margin: 1em; line-height: 1.5; }
        p { margin: 0; text-align: justify; }
    </style>
</head>
<body>
    ${chapter.split('\n').map(para => para.trim() ? `<p>${para}</p>` : '').join('')}
</body>
</html>`);
                
                tocItems += `<li><a href="${chapterFile}">Capitolo ${chapterNum}</a></li>\n`;
                manifestItems += `<item id="${chapterId}" href="${chapterFile}" media-type="application/xhtml+xml"/>\n`;
                spineItems += `<itemref idref="${chapterId}"/>\n`;
            });
            
            // Crea il file TOC
            oebps.file("toc.ncx", `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
<head>
    <meta name="dtb:uid" content="bookid"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
</head>
<docTitle><text>Libro Convertito</text></docTitle>
<navMap>
    ${tocItems}
</navMap>
</ncx>`);
            
            // Crea il file content.opf
            oebps.file("content.opf", `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="bookid">
<metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="bookid">urn:uuid:${generateUUID()}</dc:identifier>
    <dc:title>Libro Convertito</dc:title>
    <dc:language>it</dc:language>
    <dc:creator>Convertitore PDF to EPUB</dc:creator>
    <dc:date>${dateStr}</dc:date>
</metadata>
<manifest>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    ${manifestItems}
</manifest>
<spine toc="ncx">
    ${spineItems}
</spine>
</package>`);
            
            // Genera e scarica il file EPUB
            zip.generateAsync({type:"blob"}).then(function(content) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = "converted_book.epub";
                a.click();
            });
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>
</body>
</html>
